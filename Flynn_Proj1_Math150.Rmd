---
title: "Project 2"
author: "Clare Flynn"
output: pdf_document
---

In this analysis, I use data from a study testing the success of different HIV medication by Hammer et al. (1997). The response variable in the study is *time*, which indicates in days the time to death, AIDs diagnosis, or the end of the study. There is also a *censor* variable, which indicates whether each patient made it to the end of the study without a diagnosis or death, or not. The explanatory variable of interest is tx, or treatment group, so whether each patient recieved the treatment with the IDV, or the control treatment without the IDV. There are also many other potentially explanatory variables recorded, such as sex, race, age, Karnofsky score, and IV drug use history. 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(broom)
library(survival)
```

```{r, include=FALSE}
aids <- read.csv(file="AIDSdata.csv")

aids$censor[which(aids$censor==0)]
aids$censor[which(aids$censor==1)]
aids$censor_d[which(aids$censor_d==1)]
```

There are 782 uncensored data points in this study, meaning that 782 people survived and were not diagnosed with AIDs by the end of the study period. There are 69 censored data points, meaning 69 people either died or were diagnosed with AIDs before the end of the study period. Of those censored data, 20 of them died during the study.

The following histogram displays the times to diagnosis, death, or the end of the study.

```{r}
hist(aids$time, xlab="Time (days)", main="Time to Diagnosis, Death, or End of Study")
```

This next histogram shows the time to event only for those who died or were diagnosed during the study period.

```{r}
hist(aids$time[which(aids$censor==1)], xlab="Time (days)", main="Time to Diagnosis or Death")
```


```{r, include=FALSE}
pairs(~time + karnof + cd4 + age + priorzdv, data=aids)
```

The following is a Kaplan-Meier Curve for all participants in the study. The curve is not very steep, since very few participants died or were diagnosed with AIDs during the study period.

```{r}
aid.surv <- survfit(Surv(aids$time,  aids$censor)~1, data=aids)
survminer::ggsurvplot(aid.surv, conf.int=TRUE, censor=F) + ggtitle("Overall")
```

```{r, include=FALSE}
aids <-  mutate(aids, k = ifelse(karnof < 81, "lo", "hi"))
```


The following are Kaplan-Meier Curves for the groups control and high Karnofsky score (red), control and low Karnofsky score (green), treatment and high Karnofsky score (blue), and treatment and low Karnofsky score (purple). 

```{r}
aids.surv <- survfit(Surv(aids$time,  aids$censor)~tx + k, data=aids)
survminer::ggsurvplot(aids.surv, conf.int=TRUE, censor=F) + ggtitle("Overall")
```


There is a significant difference in survival time between the four groups based on the Log-Rank test (p = 3.21e-12) and Wilcoxon test  (p = 4.26e-12). There is an especially noticeable difference in survival times for those with low Karnofsky scores- those on the treatment appeared to have much higher survival probabilities than those on the control.


```{r, include=FALSE}
survdiff(Surv(aids$time, aids$censor)~txgrp + k, data=aids,  rho=0)
survdiff(Surv(aids$time, aids$censor)~txgrp + k, data=aids,  rho=1)
```



***Something New***

I will use the Weibull model in order to do a more in depth survival analysis. The Weibull model is simial to KM and Cox Hazards, but adds in the variables $\lambda$ and $p$, where $\lambda$ is a scale parameter, and $p$ is a shape parameter.

The equation for the instantaneous hazard is

$$h(t) = \lambda*p*t^{p-1}$$

The equation for the cumulative hazard is

$$ H(t) = \lambda*t^p$$

And the equation for the cumulative survival rate is 

$$ S(t) = e^{-(\lambda*t)^p}$$

The following plot is the Weibull curves plotted on top of the KM curve, since I don't know how to do it better yet.

```{r}

plot(survfit(Surv(aids$time, aids$censor)~1, data=aids))

sWei <- survreg(Surv(aids$time, aids$censor)~tx + k, data=aids,dist='weibull')

lines(predict(sWei, newdata=list(tx=1, k="lo"),type="quantile",p=seq(.01,.99,by=.01)),seq(.99,.01,by=-.01),col="purple")

lines(predict(sWei, newdata=list(tx=0, k="lo"),type="quantile",p=seq(.01,.99,by=.01)),seq(.99,.01,by=-.01),col="green")

lines(predict(sWei, newdata=list(tx=1, k="hi"),type="quantile",p=seq(.01,.99,by=.01)),seq(.99,.01,by=-.01),col="blue")

lines(predict(sWei, newdata=list(tx=0, k="hi"),type="quantile",p=seq(.01,.99,by=.01)),seq(.99,.01,by=-.01),col="red")
```

These curves look very similar to the KM curves above, but are much smoother. The extra parameters must make the function less step-wise. 

A challenge moving forward will be understanding what the different pieces of the equations for making this model mean. Especially since every source I find uses different notations for the equations.


I will use the following sources to help understand the Weibull functions (and will correctly cite them for the final project)

http://www.massey.ac.nz/massey/fms/Colleges/College%20of%20Sciences/Epicenter/docs/ASVCS/Stevenson_survival_analysis_195_721.pdf

https://www.ncbi.nlm.nih.gov/pmc/articles/PMC5233524/

https://data.princeton.edu/pop509/ParametricSurvival.pdf







